angular.module("fm.state.templates",["idlewarning.html","root.html"]),angular.module("idlewarning.html",[]).run(["$templateCache",function(a){"use strict";a.put("idlewarning.html",'<div ng-idle-countdown="idleCountdown" ng-init="idleCountdown=idleSettings.warningDuration" class="modal-body">\n  <h4><span class="icon-warning large text-danger"></span> <span data-i18n="fmState.idleMsg" data-countdown="{{idleCountdown}}"></span></h4>\n</div>\n<div class="modal-footer">\n  <div class="btn-toolbar" role="toolbar">\n    <button type="button" class="btn btn-primary" ng-click="$close()" i18n="fmState.continue"></button>\n  </div>\n</div>\n')}]),angular.module("root.html",[]).run(["$templateCache",function(a){"use strict";a.put("root.html",'<!-- Add your site or application content here -->\n<header class="header" ui-view="header"></header>\n<main class="main" ui-view="main"></main>\n')}]),angular.module("fm.state",["fm.api","fm.locale","fm.state.templates","fm.toast","fm.ui","ngIdle","ui.router"]).config(["$idleProvider","$keepaliveProvider","api",function(a,b,c){a.idleDuration(570),a.warningDuration(30),a.activeOn(""),a.keepalive(!1),b.http(c.secmgr+"/user/current")}]).run(["auth","idler","locale",function(a,b,c){b.close(),a.checkAndSetStoredCredentials(),c.ready("fmState")}]),angular.module("fm.state").constant("fmStateConstants",{tokenHeader:"X-FM-AUTH-Token",tokenStorageKey:"fmtoken",returnToUrlKey:"returnToUrl"}),function(){"use strict";function a(a,b){var c,d=a.match(/^\s*({[^}]*})\s*$/);return d&&(a=b+"("+d[1]+")"),c=a.replace(/\n/g," ").match(/^([^(]+?)\s*(\((.*)\))?$/),c&&4===c.length?{state:c[1],paramExpr:c[3]||null}:null}function b(a){var b=a.parent().inheritedData("$uiView");return b&&b.state&&b.state.name?b.state:void 0}function c(c,e,f){return{restrict:"A",require:["?^uiSrefActive","?^uiSrefActiveEq"],link:function(g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w="",x=function(){l=null,o=null,p=b(h)||c.$current,m=null,n="A"===h.prop("tagName"),q="FORM"===h[0].nodeName,s=q?"action":"href",r=!0,t={relative:p,inherit:!0},u=g.$eval(i.uiSrefOpts)||{},angular.forEach(d,function(a){a in u&&(t[a]=u[a])}),q||(h.bind("click",function(a){var b=a.which||a.button;if(!(b>1||a.ctrlKey||a.metaKey||a.shiftKey||h.attr("target"))){var d=e(function(){c.go(k.state,l,t)});a.preventDefault();var f=n&&!m?1:0;a.preventDefault=function(){f--<=0&&e.cancel(d)}}}),(v=function(){if(k=a(w,c.current.name),k&&(l={},k.paramExpr&&(l=angular.copy(g.$eval(k.paramExpr))),r)){m=c.href(k.state,l,t);var b=j[1]||j[0];return b&&b.$$setStateInfo(k.state,l),null===m?(r=!1,!1):void i.$set(s,m)}})())},y=!0;i.$observe("fmSref",function(){var a=f(i.fmSref)(g);a!==w&&(w=a,y?(y=!1,x()):v())})}}}var d=["location","inherit","reload"];c.$inject=["$state","$timeout","$interpolate"],angular.module("fm.state").directive("fmSref",c)}(),angular.module("fm.state").factory("authInterceptor",["$location","$log","$q","$window","fmStateConstants",function(a,b,c,d,e){return{responseError:function(f){if(b.debug("Response error "+f.status+": ",f.data),401===f.status){var g=a.path();"/"!==g&&d.localStorage.setItem(e.returnToUrlKey,g),a.path("/").replace()}return c.reject(f)}}}]).config(["$httpProvider",function(a){a.defaults.headers.common["Suppress-Auth-Header"]="true",a.defaults.headers.common["Cache-Control"]="no-cache",a.defaults.headers.common.Pragma="no-cache",a.interceptors.push("authInterceptor")}]),angular.module("fm.state").factory("connectionRefusedInterceptor",["$q",function(a){return{responseError:function(b){return 500===b.status&&b.data&&"string"==typeof b.data&&-1!==b.data.indexOf("ECONNREFUSED")&&(b.status=503),a.reject(b)}}}]).config(["$httpProvider",function(a){a.interceptors.push("connectionRefusedInterceptor")}]),function(){"use strict";angular.module("fm.state").factory("errorInterceptor",["$q","$log","$fmError","$timeout","toast",function(a,b,c,d,e){return{responseError:function(f){if(401!==f.status){var g=new c;b.info(f.data),f.data?"string"==typeof f.data&&(f.data={message:f.data}):f.data={message:f.statusText||""},f.data.$error=g,d(function(){g.resolved||e.addErrorMessage(f.data.message)})}return a.reject(f)}}}]).config(["$httpProvider",function(a){a.interceptors.push("errorInterceptor")}])}(),angular.module("fm.state").factory("lastResponseTimeInterceptor",["$injector",function(a){return{response:function(b){var c=a.get("auth"),d=a.get("$idle");return c.getToken()&&!d.idling()&&d.watch(),b}}}]).config(["$httpProvider",function(a){a.interceptors.push("lastResponseTimeInterceptor")}]),function(){"use strict";function a(){}a.prototype.resolved=!1,a.prototype.setResolved=function(a){this.resolved=!!a},angular.module("fm.state").service("$fmError",function(){return a})}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{authenticate:function(a,c){var e=this,g=d.defer();return this.removeToken(),b({async:!1,cache:!1,data:JSON.stringify({username:a,password:c}),method:"POST",responseType:"json",url:f.secmgr+"/authentication/login"}).success(function(a){e.setToken(a.token,a.tokenTTL),g.resolve(a)}).error(function(a){e.removeToken(),g.reject(a)}),g.promise},getToken:function(){return e.localStorage.getItem(g.tokenStorageKey)},setToken:function(a,d){a?(e.localStorage.setItem(g.tokenStorageKey,a),b.defaults.headers.common[g.tokenHeader]=a,c&&d&&(c._options().idleDuration=d-c._options().warningDuration,c.watch())):this.removeToken()},checkAndSetStoredCredentials:function(){var a=this,c=e.localStorage.getItem(g.tokenStorageKey);a.setToken(c),c&&b({cache:!1,method:"GET",responseType:"json",url:f.secmgr+"/user/current"})["catch"](function(){a.removeToken()})},removeToken:function(){e.localStorage.removeItem(g.tokenStorageKey),delete b.defaults.headers.common[g.tokenHeader],c.unwatch()},invalidateCredentials:function(){var c=a.get("$http"),d=e.localStorage.getItem(g.tokenStorageKey);d&&(b({method:"POST",url:f.secmgr+"/authentication/logout"}),this.removeToken()),e.localStorage.removeItem(g.returnToUrlKey),c.removeAll()}}}function b(){this.$get=a}a.$inject=["$cacheFactory","$http","$idle","$q","$window","api","fmStateConstants"],angular.module("fm.state").provider("auth",b)}(),function(){"use strict";function a(a,b,c,d,e){function f(){i&&(i.close(),i=null)}function g(){j=!1,f(),i=d.open({templateUrl:"idlewarning.html",windowClass:"modal-danger"}),i.result.then(function(){j||(b.ping(),a.watch())})}function h(){j=!0,f(),c.path("/timedout")}var i=null,j=!1;return e.$on("$idleStart",g),e.$on("$idleEnd",f),e.$on("$idleTimeout",h),{open:g,close:f,timeout:h}}a.$inject=["$idle","$keepalive","$location","$modal","$rootScope"],angular.module("fm.state").factory("idler",a)}(),angular.module("fm.state").provider("$qState",function(){var a=[],b=function(b){a.push(b)},c=["$state","$qStateParams","$stateParams","urlQuery","$rootScope",function(b,c,d,e,f){var g=f.$new(!0);g.actualParams={},g.$_stateParams=d,f.$on("$stateChangeStart",function(b,c,d){_.each(a,function(a){a(b,c,d)}),g.updateStateParams(angular.copy(d))});var h=f.$on("$viewContentLoaded",function(){g.updateActualParams(d),g.updateStateParams(),h()});return g.go=function(){g.updateActualParams(angular.copy(arguments[1])),b.go.apply(b,arguments).then(function(){g.applySearch(),g.clearActualParams()})},g.transitionTo=function(){g.updateActualParams(angular.copy(arguments[1])),b.transitionTo.apply(b,arguments).then(function(){g.applySearch(),g.clearActualParams()})},g.updateActualParams=function(a){g.clearActualParams();for(var b in a)g.actualParams[b]=a[b]},g.updateStateParams=function(a){var b;g.clearQStateParams();var d=angular.copy(g.actualParams);if(void 0!==a)for(b in a)d[b]=a[b];for(b in d)c[b]=d[b]},g.clearActualParams=function(){for(var a in g.actualParams)delete g.actualParams[a]},g.clearQStateParams=function(){for(var a in c)delete c[a]},g.applySearch=function(){"undefined"!=typeof g.actualParams.$q&&e.setParams(g.actualParams.$q)},{go:g.go,transitionTo:g.transitionTo,href:b.href,current:b.current,$current:b.$current,get:b.get,includes:b.includes,is:b.is,reload:b.reload}}];return{$get:c,middleware:b}}),angular.module("fm.state").factory("$qStateParams",function(){return{}}),angular.module("fm.state").factory("urlQuery",["$rootScope","$stateParams","$location",function(a,b,c){var d=a.$new(!0);d.$stateParams=b,d.params={},d.$watching=null,d.unregister=null,a.$on("$locationChangeSuccess",function(){q()});var e=function(a){"object"==typeof a&&(a=h(a)),"?"===a[0]&&(a=a.substr(1)),c.search(a)},f=function(a){if(i(),"string"==typeof a){"?"===a[0]&&(a=a.substr(1));for(var b=a.split("&"),c=0;c<b.length;c++){var e=b[c],f=e.split("=");d.params[decodeURIComponent(f[0])]=decodeURIComponent(f[1])}}else for(var g in a)d.params[g]=a[g]},g=function(){return h(d.params)},h=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},i=function(){for(var a in d.params)delete d.params[a]},j=function(a){null!==d.unregister&&d.unregister(),d.$watching=a,d.unregister=d.$watch("$watching",function(){e(a)},!0)},k=function(){null!==d.unregister&&d.unregister()},l=function(a){return d.params[a]},m=function(a,b){var c=angular.copy(d.params);c[a]=b,e(c)},n=function(a){var b=angular.copy(d.params);delete b[a],e(b)},o=function(a){return"undefined"!=typeof d.params[a]},p=function(a){return a===!0?angular.copy(d.params):d.params},q=function(){var a=c.search();Object.keys(a).length>0?f(a):i()};return{get:l,set:m,unset:n,has:o,getParams:p,setParams:e,startWatching:j,stopWatching:k,getQueryString:g,readUrl:q}}]),angular.module("fm.state").config(["$stateProvider",function(a){a.state("root.logout",{url:"/logout",views:{header:{template:""},main:{template:"",controller:["$rootScope","$state","auth",function(a,b,c){c.invalidateCredentials(),a.$broadcast("fmlogout"),b.go("root.login",{},{location:"replace",reload:!0,notify:!0})}]}}})}]),angular.module("fm.state").config(["$stateProvider",function(a){a.state("root",{"abstract":!0,resolve:{locale:["locale",function(a){return a.ready("common").then(function(){return a})}]},views:{root:{templateUrl:"root.html"}}})}]),angular.module("fm.state").config(["$stateProvider",function(a){a.state("root.timedout",{url:"/timedout",views:{header:{template:""},main:{template:"",controller:["$state","$stateParams","locale","toast",function(a,b,c,d){d.addStickyErrorMessage(c.getString("fmState.timedout")),a.transitionTo("root.logout",b,{location:"replace",reload:!0,notify:!0})}]}}})}]);